{% extends "base.html" %}

{% block title %}
dashboard
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>實時網路流量 (Kbps)</h2>
    <canvas id="myChart" width="800" height="400"></canvas>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // 自動呼叫啟動封包捕獲的 API
    fetch('/start_capture')
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('Error starting capture:', error));

    const ctx = document.getElementById('myChart').getContext('2d');

    // 設置 Chart.js 的初始資料
    const initialData = {
        datasets: [{
            label: '實時流量 (Kbps)',
            data: [],
            fill: false,
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1
        }]
    };

    const config = {
        type: 'line',
        data: initialData,
        options: {
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'second',
                        tooltipFormat: 'YYYY-MM-DD HH:mm:ss',
                        displayFormats: {
                            second: 'HH:mm:ss',
                        }
                    },
                    title: {
                        display: true,
                        text: '時間'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '流量 (Kbps)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            }
        }
    };

    const chart = new Chart(ctx, config);

    function fetchPacketData() {
        fetch('/dashboard/data')
            .then(response => response.json())
            .then(data => {
                const now = Date.now();
                const latestTraffic = data.length > 0 ? data[data.length - 1] : 0;

                // 添加數據點
                chart.data.datasets[0].data.push({
                    x: now,
                    y: latestTraffic
                });

                // 移除舊的數據以保持圖表在一定時間內的數據量
                if (chart.data.datasets[0].data.length > 60) {
                    chart.data.datasets[0].data.shift();
                }

                // 更新圖表
                chart.update('none');
            })
            .catch(error => console.error('Error fetching data:', error));
    }

    // 設置每秒更新一次數據
    setInterval(fetchPacketData, 1000);
});
</script>
{% endblock %}
